{"version":3,"file":"index.js","sources":["../src/rqx.js","../src/olfactory.js","../src/scrollend.js","../src/index.js"],"sourcesContent":["function isBeacon() {\n    return navigator.sendBeacon\n}\n\nfunction buildPost() {\n    return new Function('var xhr=new XMLHttpRequest();xhr.open(\"POST\",arguments[0],true);xhr.withCredentials = true;xhr.send(arguments[1]);');\n}\n\nfunction $post(url, data = {}) {\n    // aplus打点影响，去掉beacon上报\n    // if(navigator.sendBeacon) {\n    //     navigator.sendBeacon(url, JSON.stringify(data))\n    // } else {\n    //     const post = buildPost()\n    //     post(url, JSON.stringify(data))\n    // }\n    const post = buildPost()\n    post(url, JSON.stringify(data))\n}\n\nfunction $get(url, success) {\n    const img = new Image()\n    img.style.display = \"none\"\n    img.src = url\n    document.body.appendChild(img);\n    success && success()\n    //删除Dom\n    setTimeout(() => {\n        document.body.removeChild(img)\n    }, 50)\n}\n\nexport default {\n    isBeacon,\n    $post,\n    $get\n}\n","let _exp = undefined\nconst { getConfig, getProps } = window.jplusUtil\n\nexport default class Olfactory {\n    constructor(epx) {\n        _exp = epx\n        this.removeT = undefined\n        this.insetT = undefined\n        this.options = []\n        this.onEventListener()\n        this.onscroll()\n    }\n    initConfig() {\n        this.config = []\n        getConfig('exp').map((item, index) => {\n            const { config, expShouldRecord, expWillRecord, expDidRecord } = item\n            config.selector = config.selector || '.jplus-exp'\n            config.visible = config.visible || '0.3'\n            config.duration = config.duration || '300'\n            config.method = config.method || 'get'\n            config.postSize = config.postSize || '10'\n            config.tagName = config.tagName || 'data-jplus-exp'\n            config.propsMap = config.propsMap || {\n                url: 'data-jplus-exp-url'\n            }\n            config.groupIndex = index\n            this.config.push(Object.assign(config, {\n                expShouldRecord,\n                expWillRecord,\n                expDidRecord\n            }))\n        })\n    }\n    supConfig(ele, index) {\n        let url = undefined\n        const config = this.config[index]\n        if(ele) {\n            const props = getProps(ele)\n            url = props[config.propsMap.url]\n            const newConfig = Object.assign({}, config, {\n                ele,\n                url,\n                props\n            })\n            this.config[index] = newConfig\n            return newConfig\n        }\n    }\n    onEventListener() {\n        window.addEventListener(\"scroll\", this.onscroll.bind(this))\n\n        window.addEventListener(\"DOMNodeInserted\", (event) => {\n            try {\n                if(!this.insetT) {\n                    this.insetT = setTimeout(() => {\n                        this.onscroll()\n                        clearTimeout(this.insetT)\n                        this.insetT = undefined\n                    }, 100)\n                }\n            } catch(e) {\n                console.error(e)\n            }\n        })\n\n        window.addEventListener(\"DOMNodeRemoved\", (event) => {\n            try {\n                if(!this.removeT) {\n                    this.removeT = setTimeout(() => {\n                        this.onscroll()\n                        clearTimeout(this.removeT)\n                        this.removeT = undefined\n                    }, 100)\n                }\n            } catch(e) {\n                console.error(e)\n            }\n        })\n    }\n\n    // 轮询\n    onscroll() {\n        if (this.scrollTimer) {\n            clearTimeout(this.scrollTimer);\n        }\n        this.scrollTimer = setTimeout(() => {\n            if (this.scrollTimer) {\n                clearTimeout(this.scrollTimer)\n            }\n            this.calculate()\n        }, 50)\n    }\n\n    // 计算dom\n    calculate() {\n        const scrollTop =\n            document.documentElement.scrollTop ||\n            window.pageYOffset ||\n            document.body.scrollTop\n        const scrollBottom = scrollTop + document.documentElement.clientHeight\n        this.initConfig()\n        this.config.map((item, index) => {\n            const selector = item['selector']\n            const els = document.querySelectorAll(selector) || []\n\n            //检测元素\n            for (let i = 0; i < els.length; i++) {\n                const ele = els[i];\n                if (ele.style.visibility != \"hidden\" && ele.style.display != \"none\") {\n                    const jplustag = ele.getAttribute(item.tagName)\n                    if (jplustag) continue;\n                    //判断是否在视野区域\n                    const top = this.getDocumentOffsetTop(ele)\n                    const height = ele.offsetHeight\n                    const bottom = top + height\n                    const inTop = top + height * item.visible\n                    const inBottom = bottom - height * item.visible\n\n                    if (inBottom > scrollTop && inTop < scrollBottom) {\n                        // 在视口，等待发送，需要发送\n                        // 避免重复发送\n                        // 出发标识\n                        const newConfig = this.supConfig(ele, index)\n                        _exp.record(newConfig, ele, newConfig.props, this.config)\n                    }\n                }\n            }\n        })\n    }\n\n    // 计算父节点\n    getDocumentOffsetTop(ele) {\n        // ele.offsetParent 取最近的ele的父级别元素 定位部位position 不为static 的元素\n        if (ele.offsetParent !== null) {\n            const top = this.getDocumentOffsetTop(ele.offsetParent);\n            return ele.offsetTop + top;\n        } else {\n            return ele.offsetTop;\n        }\n    }\n}\n","let timer = null; // 定时器\n\nfunction getScrollTop () {\n    return document.documentElement.scrollTop || document.body.scrollTop;\n}\n\nfunction isScrollEnd(t1) {\n    const t2 = getScrollTop();\n    return t2 === t1\n}\n\nfunction combination(success) {\n    clearTimeout(timer);\n    const t1 = getScrollTop();\n    timer = setTimeout(() => {\n        if(isScrollEnd(t1)) {\n            if(success()) combination(success)\n        }\n    }, 500);\n}\n\nexport default {\n    watch(success = function() {}) {\n        combination(success)\n        // scroll监听\n        window.addEventListener('scroll', () => {\n            combination(success)\n        })\n    }\n}","/*\n * @Author: puxiao.wh\n * @Date: 2019-01-10 22:56:59\n * @LastEditors: puxiao.wh\n * @LastEditTime: 2019-01-22 14:54:58\n * @Description: \n */\n\nimport Rqx from './rqx'\nimport olfactory from './olfactory'\nimport scrollend from './scrollend'\nconst { isDebug } = window.jplusUtil\n\n// 是否继续执行\nfunction expShouldRecord(config, ele, props) {\n    if (config.expShouldRecord) {\n        return config.expShouldRecord(config, ele, props)\n    }\n    return true\n}\n// 请求之前对数据进行加工，返回值为新值\nfunction expWillRecord(config, ele, props) {\n    if (config.expWillRecord) {\n        return config.expWillRecord(config, ele, props)\n    }\n    return config\n}\n// 请求发送后调用，但不确保请求成功\nfunction expDidRecord(config, ele, props, data) {\n    if (config.expDidRecord) {\n        return config.expDidRecord(config, ele, props, data)\n    }\n    return config\n}\n\nconst jplugPluginExp = {\n    record(config, ele, props, configList) {\n        if (expShouldRecord(config, ele, props)) {\n            const newConfig = Object.assign({}, expWillRecord(config, ele, props))\n            let url = newConfig.url\n            const method = newConfig.method\n            const postSize = newConfig.postSize\n\n            if (url) {\n                // jplus上报增加有效曝光flag\n                if (url.indexOf(\"&pv_valid\") === -1) {\n                    url = url + \"&pv_valid=1\";\n                }\n                if (method === 'get') {\n                    Rqx.$get(url)\n                    expDidRecord(newConfig, newConfig.ele, newConfig.props)\n                    ele.setAttribute(newConfig.tagName, 'true')\n\n                    if(isDebug) {\n                        console.group('jplus-plugin-exp，信息提示')\n                            console.info('Get请求上报成功')\n                            console.log('上报地址：', url)\n                            console.log('元素节点：', ele)\n                            if(configList) {\n                                console.log('返回参数：', configList)\n                            } else {\n                                console.log('返回参数：', config)\n                            }\n                        console.groupEnd()\n                    }\n                } else if (method === 'post') {\n                    if (Array.isArray(window.jplus.plugin.exp[newConfig.groupIndex].postDataList)) {\n                        window.jplus.plugin.exp[newConfig.groupIndex].postDataList.push(url)\n                    } else {\n                        window.jplus.plugin.exp[newConfig.groupIndex].postDataList = [url]\n                    }\n                    ele.setAttribute(newConfig.tagName, 'true')\n\n                    // 缓存策略\n                    scrollend.watch(() => {\n                        window.jplus.plugin.exp.map((item, index) => {\n                            const config = configList[index]\n                            let dataList = []\n                            if (postSize === 'max') {\n                                dataList = window.jplus.plugin.exp[index].postDataList\n                                window.jplus.plugin.exp[index].postDataList = []\n                            } else {\n                                dataList = window.jplus.plugin.exp[index].postDataList.splice(0, postSize)\n                            }\n                            if (dataList.length !== 0) {\n                                Rqx.$post(config.postUrl, {\n                                    [config['postParams']]: dataList\n                                })\n                                expDidRecord(config, config.ele, config.props, {\n                                    [config['postParams']]: dataList\n                                })\n                                if(isDebug) {\n                                    console.group('jplus-plugin-exp，信息提示')\n                                        console.info('Post请求上报成功')\n                                        console.log('上报地址：', dataList)\n                                        console.log('元素节点：', ele)\n                                        if(configList) {\n                                            console.log('返回参数：', configList)\n                                        } else {\n                                            console.log('返回参数：', config)\n                                        }\n                                    console.groupEnd()\n                                }\n                            }\n                        })\n                    })\n                }\n            } else {\n                if(isDebug) {\n                    console.group('jplus-plugin-exp，信息提示')\n                        console.warn('缺少上报地址')\n                        console.log('元素节点：', ele)\n                        if(configList) {\n                            console.log('返回参数：', configList)\n                        } else {\n                            console.log('返回参数：', config)\n                        }\n                    console.groupEnd()\n                } else {\n                    console.warn(`存在错误信息，请使用该链接访问查看错误: ${location.href}&_jplusDebugModel_=1`)\n                }\n            }\n        }\n    }\n}\n\nnew olfactory(jplugPluginExp)\n\nexport default {\n    olfactory,\n    jplugPluginExp\n}\n"],"names":["navigator","sendBeacon","url","data","Function","JSON","stringify","success","img","Image","style","display","src","body","appendChild","removeChild","_exp","undefined","window","jplusUtil","getConfig","getProps","Olfactory","epx","removeT","insetT","options","onEventListener","onscroll","config","map","item","index","expShouldRecord","expWillRecord","expDidRecord","selector","visible","duration","method","postSize","tagName","propsMap","groupIndex","push","Object","assign","ele","this","props","newConfig","addEventListener","bind","event","_this2","setTimeout","e","error","scrollTimer","_this3","calculate","scrollTop","document","documentElement","pageYOffset","scrollBottom","clientHeight","initConfig","els","querySelectorAll","i","length","visibility","getAttribute","top","_this4","getDocumentOffsetTop","height","offsetHeight","bottom","inTop","supConfig","record","offsetParent","offsetTop","timer","getScrollTop","combination","t1","isScrollEnd","isDebug","jplugPluginExp","configList","indexOf","$get","setAttribute","group","info","log","groupEnd","Array","isArray","jplus","plugin","exp","postDataList","dataList","splice","$post","postUrl","warn","location","href","olfactory"],"mappings":"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"}